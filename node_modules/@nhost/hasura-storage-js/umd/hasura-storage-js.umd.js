(function(U,M){typeof exports=="object"&&typeof module!="undefined"?M(exports):typeof define=="function"&&define.amd?define(["exports"],M):(U=typeof globalThis!="undefined"?globalThis:U||self,M(U["@nhost/hasura-storage-js"]={}))})(this,function(U){"use strict";var Lr=Object.defineProperty;var Ir=(U,M,X)=>M in U?Lr(U,M,{enumerable:!0,configurable:!0,writable:!0,value:X}):U[M]=X;var et=(U,M,X)=>Ir(U,typeof M!="symbol"?M+"":M,X);const M=async(e,t,{accessToken:r,name:n,fileId:a,bucketId:i,adminSecret:o,onUploadProgress:s,headers:u={}}={})=>{var y;const l={...u};if(i&&t.append("bucket-id",i),o&&(l["x-hasura-admin-secret"]=o),r&&(l.Authorization=`Bearer ${r}`),(n||a)&&!t.has("metadata[]")){const f={};n&&(f.name=n),a&&(f.id=a),t.append("metadata[]",new Blob([JSON.stringify(f)],{type:"application/json"}),"")}const v=`${e}/files`;if(typeof XMLHttpRequest=="undefined")try{const f=await fetch(v,{method:"POST",headers:l,body:t}),d=await f.json();return f.ok?{fileMetadata:d,error:null}:{error:{status:f.status,message:((y=d==null?void 0:d.error)==null?void 0:y.message)||f.statusText,error:f.statusText},fileMetadata:null}}catch(f){return{error:{status:0,message:f.message,error:f.message},fileMetadata:null}}return new Promise(f=>{let d=new XMLHttpRequest;d.responseType="json",d.onload=()=>{var p,h,S,g,m,w,O,L;if(d.status<200||d.status>=300){const j={error:(m=(g=(h=(p=d.response)==null?void 0:p.error)==null?void 0:h.message)!=null?g:(S=d.response)==null?void 0:S.error)!=null?m:d.response,message:(L=(O=(w=d.response)==null?void 0:w.error)==null?void 0:O.message)!=null?L:d.response,status:d.status};return f({fileMetadata:null,error:j})}return f({fileMetadata:d.response,error:null})},d.onerror=()=>{const p={error:d.statusText,message:d.statusText,status:d.status};return f({fileMetadata:null,error:p})},s&&d.upload.addEventListener("progress",s,!1),d.open("POST",v,!0),Object.entries(l).forEach(([p,h])=>{d.setRequestHeader(p,h)}),d.send(t)})};function X(e,t){if(!t||Object.keys(t).length===0)return e;const r=new URL(e),n=Object.entries(t).reduce((a,[i,o])=>({...a,[i.charAt(0)]:o}),{});return Object.entries(n).forEach(([a,i])=>{i&&r.searchParams.set(a,i)}),r.toString()}class Qt{constructor({url:t}){et(this,"url");et(this,"accessToken");et(this,"adminSecret");et(this,"headers",{});this.url=t}async uploadFormData({formData:t,bucketId:r,headers:n}){const{error:a,fileMetadata:i}=await M(this.url,t,{bucketId:r,headers:{...this.headers,...n},accessToken:this.accessToken,adminSecret:this.adminSecret});return a?{fileMetadata:null,error:a}:i&&!("processedFiles"in i)?{fileMetadata:{processedFiles:[i]},error:null}:{fileMetadata:i,error:null}}async uploadFile({file:t,bucketId:r,id:n,name:a,headers:i}){const o=new FormData;o.append("file[]",t),o.append("metadata[]",new Blob([JSON.stringify({id:n,name:a})],{type:"application/json"}),"");const{error:s,fileMetadata:u}=await M(this.url,o,{accessToken:this.accessToken,adminSecret:this.adminSecret,bucketId:r,headers:{...this.headers,...i}});return s?{fileMetadata:null,error:s}:u&&"processedFiles"in u?{fileMetadata:u.processedFiles[0],error:null}:{fileMetadata:u,error:null}}async downloadFile(t){try{const{fileId:r,headers:n,...a}=t,i=X(`${this.url}/files/${r}`,a),o=await fetch(i,{method:"GET",headers:{...this.generateAuthHeaders(),...this.headers,...n}});if(!o.ok)throw new Error(await o.text());return{file:await o.blob(),error:null}}catch(r){return{file:null,error:r}}}async getPresignedUrl(t){try{const{fileId:r,headers:n}=t,a=await fetch(`${this.url}/files/${r}/presignedurl`,{method:"GET",headers:{...this.generateAuthHeaders(),...this.headers,...n}});if(!a.ok)throw new Error(await a.text());return{presignedUrl:await a.json(),error:null}}catch(r){return{presignedUrl:null,error:r}}}async delete(t){try{const{fileId:r,headers:n}=t,a=await fetch(`${this.url}/files/${r}`,{method:"DELETE",headers:{...this.generateAuthHeaders(),...this.headers,...n}});if(!a.ok)throw new Error(await a.text());return{error:null}}catch(r){return{error:r}}}setAccessToken(t){return this.accessToken=t,this}setAdminSecret(t){return this.adminSecret=t,this}getHeaders(){return this.headers}setHeaders(t){return t?(this.headers={...this.headers,...t},this):this}unsetHeaders(){const t=this.headers["x-hasura-role"];return this.headers=t?{"x-hasura-role":t}:{},this}generateAuthHeaders(){if(!(!this.adminSecret&&!this.accessToken))return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:{Authorization:`Bearer ${this.accessToken}`}}}class Ge{constructor({url:t,adminSecret:r}){et(this,"url");et(this,"api");this.url=t,this.api=new Qt({url:t}),this.setAdminSecret(r)}async upload(t){return"file"in t?this.api.uploadFile(t):this.api.uploadFormData(t)}getPublicUrl(t){const{fileId:r,...n}=t;return X(`${this.url}/files/${r}`,n)}async getPresignedUrl(t){const{fileId:r,headers:n,...a}=t,{presignedUrl:i,error:o}=await this.api.getPresignedUrl(t);if(o)return{presignedUrl:null,error:o};if(!i)return{presignedUrl:null,error:new Error("Invalid file id")};const s=X(i.url,a);return{presignedUrl:{...i,url:s},error:null}}async download(t){const{file:r,error:n}=await this.api.downloadFile(t);return n?{file:null,error:n}:r?{file:r,error:null}:{file:null,error:new Error("File does not exist")}}async delete(t){const{error:r}=await this.api.delete(t);return r?{error:r}:{error:null}}setAccessToken(t){return this.api.setAccessToken(t),this}setAdminSecret(t){return this.api.setAdminSecret(t),this}getHeaders(){return this.api.getHeaders()}setHeaders(t){return this.api.setHeaders(t),this}unsetHeaders(){return this.api.unsetHeaders(),this}}/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var c=function(){return c=Object.assign||function(t){for(var r,n=1,a=arguments.length;n<a;n++){r=arguments[n];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},c.apply(this,arguments)};function Mt(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]]);return r}function D(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function A(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),a,i=[],o;try{for(;(t===void 0||t-- >0)&&!(a=n.next()).done;)i.push(a.value)}catch(s){o={error:s}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return i}function b(e,t,r){if(arguments.length===2)for(var n=0,a=t.length,i;n<a;n++)(i||!(n in t))&&(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}var P;(function(e){e.Start="xstate.start",e.Stop="xstate.stop",e.Raise="xstate.raise",e.Send="xstate.send",e.Cancel="xstate.cancel",e.NullEvent="",e.Assign="xstate.assign",e.After="xstate.after",e.DoneState="done.state",e.DoneInvoke="done.invoke",e.Log="xstate.log",e.Init="xstate.init",e.Invoke="xstate.invoke",e.ErrorExecution="error.execution",e.ErrorCommunication="error.communication",e.ErrorPlatform="error.platform",e.ErrorCustom="xstate.error",e.Update="xstate.update",e.Pure="xstate.pure",e.Choose="xstate.choose"})(P||(P={}));var rt;(function(e){e.Parent="#_parent",e.Internal="#_internal"})(rt||(rt={}));var $t=P.Start,kt=P.Stop,lt=P.Raise,wt=P.Send,Zt=P.Cancel,te=P.NullEvent,xt=P.Assign,ze=P.After,Je=P.DoneState,Ct=P.Log,ee=P.Init,Et=P.Invoke,Ye=P.ErrorExecution,qe=P.ErrorPlatform,re=P.ErrorCustom,Ht=P.Update,ne=P.Choose,ie=P.Pure;const We=Object.freeze(Object.defineProperty({__proto__:null,after:ze,assign:xt,cancel:Zt,choose:ne,doneState:Je,error:re,errorExecution:Ye,errorPlatform:qe,init:ee,invoke:Et,log:Ct,nullEvent:te,pure:ie,raise:lt,send:wt,start:$t,stop:kt,update:Ht},Symbol.toStringTag,{value:"Module"}));var ae=".",oe={},_t="xstate.guard",Xe="",H=process.env.NODE_ENV==="production",Ot;function Gt(e,t,r){r===void 0&&(r=ae);var n=ft(e,r),a=ft(t,r);return E(a)?E(n)?a===n:!1:E(n)?n in a:Object.keys(n).every(function(i){return i in a?Gt(n[i],a[i]):!1})}function se(e){try{return E(e)||typeof e=="number"?"".concat(e):e.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function zt(e,t){try{return dt(e)?e:e.toString().split(t)}catch{throw new Error("'".concat(e,"' is not a valid state path."))}}function Be(e){return typeof e=="object"&&"value"in e&&"context"in e&&"event"in e&&"_event"in e}function ft(e,t){if(Be(e))return e.value;if(dt(e))return At(e);if(typeof e!="string")return e;var r=zt(e,t);return At(r)}function At(e){if(e.length===1)return e[0];for(var t={},r=t,n=0;n<e.length-1;n++)n===e.length-2?r[e[n]]=e[n+1]:(r[e[n]]={},r=r[e[n]]);return t}function ct(e,t){for(var r={},n=Object.keys(e),a=0;a<n.length;a++){var i=n[a];r[i]=t(e[i],i,e,a)}return r}function ue(e,t,r){var n,a,i={};try{for(var o=D(Object.keys(e)),s=o.next();!s.done;s=o.next()){var u=s.value,l=e[u];r(l)&&(i[u]=t(l,u,e))}}catch(v){n={error:v}}finally{try{s&&!s.done&&(a=o.return)&&a.call(o)}finally{if(n)throw n.error}}return i}var Ve=function(e){return function(t){var r,n,a=t;try{for(var i=D(e),o=i.next();!o.done;o=i.next()){var s=o.value;a=a[s]}}catch(u){r={error:u}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return a}};function Ke(e,t){return function(r){var n,a,i=r;try{for(var o=D(e),s=o.next();!s.done;s=o.next()){var u=s.value;i=i[t][u]}}catch(l){n={error:l}}finally{try{s&&!s.done&&(a=o.return)&&a.call(o)}finally{if(n)throw n.error}}return i}}function Pt(e){if(!e)return[[]];if(E(e))return[[e]];var t=R(Object.keys(e).map(function(r){var n=e[r];return typeof n!="string"&&(!n||!Object.keys(n).length)?[[r]]:Pt(e[r]).map(function(a){return[r].concat(a)})}));return t}function R(e){var t;return(t=[]).concat.apply(t,b([],A(e),!1))}function le(e){return dt(e)?e:[e]}function G(e){return e===void 0?[]:le(e)}function fe(e,t,r){var n,a;if(T(e))return e(t,r.data);var i={};try{for(var o=D(Object.keys(e)),s=o.next();!s.done;s=o.next()){var u=s.value,l=e[u];T(l)?i[u]=l(t,r.data):i[u]=l}}catch(v){n={error:v}}finally{try{s&&!s.done&&(a=o.return)&&a.call(o)}finally{if(n)throw n.error}}return i}function Qe(e){return/^(done|error)\./.test(e)}function Ze(e,t){var r,n,a=A([[],[]],2),i=a[0],o=a[1];try{for(var s=D(e),u=s.next();!u.done;u=s.next()){var l=u.value;t(l)?i.push(l):o.push(l)}}catch(v){r={error:v}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return[i,o]}function ce(e,t){return ct(e.states,function(r,n){if(r){var a=(E(t)?void 0:t[n])||(r?r.current:void 0);if(a)return{current:a,states:ce(r,a)}}})}function tr(e,t){return{current:t,states:ce(e,t)}}function de(e,t,r,n){H||q(!!e,"Attempting to update undefined context");var a=e&&r.reduce(function(i,o){var s,u,l=o.assignment,v={state:n,action:o,_event:t},y={};if(T(l))y=l(i,t.data,v);else try{for(var f=D(Object.keys(l)),d=f.next();!d.done;d=f.next()){var p=d.value,h=l[p];y[p]=T(h)?h(i,t.data,v):h}}catch(S){s={error:S}}finally{try{d&&!d.done&&(u=f.return)&&u.call(f)}finally{if(s)throw s.error}}return Object.assign({},i,y)},e);return a}var q=function(){};H||(q=function(e,t){var r=e instanceof Error?e:void 0;if(!(!r&&e)&&console!==void 0){var n=["Warning: ".concat(t)];r&&n.push(r),console.warn.apply(console,n)}});function dt(e){return Array.isArray(e)}function T(e){return typeof e=="function"}function E(e){return typeof e=="string"}function he(e,t){if(e)return E(e)?{type:_t,name:e,predicate:t?t[e]:void 0}:T(e)?{type:_t,name:e.name,predicate:e}:e}var ve=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Ot={},Ot[ve]=function(){return this},Ot[Symbol.observable]=function(){return this};function Q(e){return!!e&&"__xstatenode"in e}var er=function(){var e=0;return function(){return e++,e.toString(16)}}();function Jt(e,t){return E(e)||typeof e=="number"?c({type:e},t):e}function ht(e,t){if(!E(e)&&"$$type"in e&&e.$$type==="scxml")return e;var r=Jt(e);return c({name:r.type,data:r,$$type:"scxml",type:"external"},t)}function nt(e,t){var r=le(t).map(function(n){return typeof n=="undefined"||typeof n=="string"||Q(n)?{target:n,event:e}:c(c({},n),{event:e})});return r}function rr(e){if(!(e===void 0||e===Xe))return G(e)}function pe(e,t,r,n,a){var i=e.options.guards,o={state:a,cond:t,_event:n};if(t.type===_t)return((i==null?void 0:i[t.name])||t.predicate)(r,n.data,o);var s=i==null?void 0:i[t.type];if(!s)throw new Error("Guard '".concat(t.type,"' is not implemented on machine '").concat(e.id,"'."));return s(r,n.data,o)}function nr(e){return typeof e=="string"?{type:e}:e}function bt(e,t){return"".concat(e,":invocation[").concat(t,"]")}function ye(e){return(e.type===lt||e.type===wt&&e.to===rt.Internal)&&typeof e.delay!="number"}var Tt=ht({type:ee});function Yt(e,t){return t&&t[e]||void 0}function it(e,t){var r;if(E(e)||typeof e=="number"){var n=Yt(e,t);T(n)?r={type:e,exec:n}:n?r=n:r={type:e,exec:void 0}}else if(T(e))r={type:e.name||e.toString(),exec:e};else{var n=Yt(e.type,t);if(T(n))r=c(c({},e),{exec:n});else if(n){var a=n.type||e.type;r=c(c(c({},n),e),{type:a})}else r=e}return r}var B=function(e,t){if(!e)return[];var r=dt(e)?e:[e];return r.map(function(n){return it(n,t)})};function jt(e){var t=it(e);return c(c({id:E(e)?e:t.id},t),{type:t.type})}function ge(e,t){return{type:lt,event:typeof e=="function"?e:Jt(e),delay:t?t.delay:void 0,id:t==null?void 0:t.id}}function me(e,t,r,n){var a={_event:r},i=ht(T(e.event)?e.event(t,r.data,a):e.event),o;if(E(e.delay)){var s=n&&n[e.delay];o=T(s)?s(t,r.data,a):s}else o=T(e.delay)?e.delay(t,r.data,a):e.delay;return c(c({},e),{type:lt,_event:i,delay:o})}function Z(e,t){return{to:t?t.to:void 0,type:wt,event:T(e)?e:Jt(e),delay:t?t.delay:void 0,id:t&&t.id!==void 0?t.id:T(e)?e.name:se(e)}}function Se(e,t,r,n){var a={_event:r},i=ht(T(e.event)?e.event(t,r.data,a):e.event),o;if(E(e.delay)){var s=n&&n[e.delay];o=T(s)?s(t,r.data,a):s}else o=T(e.delay)?e.delay(t,r.data,a):e.delay;var u=T(e.to)?e.to(t,r.data,a):e.to;return c(c({},e),{to:u,_event:i,event:i.data,delay:o})}function qt(e,t){return Z(e,c(c({},t),{to:rt.Parent}))}function ir(e,t,r){return Z(t,c(c({},r),{to:e}))}function ar(){return qt(Ht)}function or(e,t){return Z(e,c(c({},t),{to:function(r,n,a){var i=a._event;return i.origin}}))}var sr=function(e,t){return{context:e,event:t}};function ur(e,t){return e===void 0&&(e=sr),{type:Ct,label:t,expr:e}}var we=function(e,t,r){return c(c({},e),{value:E(e.expr)?e.expr:e.expr(t,r.data,{_event:r})})},xe=function(e){return{type:Zt,sendId:e}};function Ee(e){var t=jt(e);return{type:P.Start,activity:t,exec:void 0}}function Oe(e){var t=T(e)?e:jt(e);return{type:P.Stop,activity:t,exec:void 0}}function Ae(e,t,r){var n=T(e.activity)?e.activity(t,r.data):e.activity,a=typeof n=="string"?{id:n}:n,i={type:P.Stop,activity:a};return i}var Pe=function(e){return{type:xt,assignment:e}};function lr(e){return typeof e=="object"&&"type"in e}function be(e,t){var r=t?"#".concat(t):"";return"".concat(P.After,"(").concat(e,")").concat(r)}function vt(e,t){var r="".concat(P.DoneState,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function Te(e,t){var r="".concat(P.DoneInvoke,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function je(e,t){var r="".concat(P.ErrorPlatform,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function fr(e){return{type:P.Pure,get:e}}function cr(e,t){if(!H&&(!e||typeof e=="function")){var r=e;e=function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var i=typeof r=="function"?r.apply(void 0,b([],A(n),!1)):r;if(!i)throw new Error("Attempted to forward event to undefined actor. This risks an infinite loop in the sender.");return i}}return Z(function(n,a){return a},c(c({},t),{to:e}))}function dr(e,t){return qt(function(r,n,a){return{type:re,data:T(e)?e(r,n,a):e}},c(c({},t),{to:rt.Parent}))}function hr(e){return{type:P.Choose,conds:e}}var vr=function(e){var t,r,n=[];try{for(var a=D(e),i=a.next();!i.done;i=a.next())for(var o=i.value,s=0;s<o.actions.length;){if(o.actions[s].type===xt){n.push(o.actions[s]),o.actions.splice(s,1);continue}s++}}catch(u){t={error:u}}finally{try{i&&!i.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return n};function Dt(e,t,r,n,a,i,o){o===void 0&&(o=!1);var s=o?[]:vr(a),u=s.length?de(r,n,s,t):r,l=o?[r]:void 0,v=[];function y(p,h){var S;switch(h.type){case lt:{var g=me(h,u,n,e.options.delays);return i&&typeof g.delay=="number"&&i(g,u,n),g}case wt:var m=Se(h,u,n,e.options.delays);if(!H){var w=h.delay;q(!E(w)||typeof m.delay=="number","No delay reference for delay expression '".concat(w,"' was found on machine '").concat(e.id,"'"))}return i&&m.to!==rt.Internal&&(p==="entry"?v.push(m):i(m,u,n)),m;case Ct:{var O=we(h,u,n);return i==null||i(O,u,n),O}case ne:{var L=h,j=(S=L.conds.find(function(tt){var K=he(tt.cond,e.options.guards);return!K||pe(e,K,u,n,i?void 0:t)}))===null||S===void 0?void 0:S.actions;if(!j)return[];var $=A(Dt(e,t,u,n,[{type:p,actions:B(G(j),e.options.actions)}],i,o),2),I=$[0],_=$[1];return u=_,l==null||l.push(u),I}case ie:{var j=h.get(u,n.data);if(!j)return[];var F=A(Dt(e,t,u,n,[{type:p,actions:B(G(j),e.options.actions)}],i,o),2),x=F[0],N=F[1];return u=N,l==null||l.push(u),x}case kt:{var O=Ae(h,u,n);return i==null||i(O,r,n),O}case xt:{u=de(u,n,[h],i?void 0:t),l==null||l.push(u);break}default:var k=it(h,e.options.actions),W=k.exec;if(i)i(k,u,n);else if(W&&l){var St=l.length-1,Kt=c(c({},k),{exec:function(tt){for(var K=[],z=1;z<arguments.length;z++)K[z-1]=arguments[z];W.apply(void 0,b([l[St]],A(K),!1))}});k=Kt}return k}}function f(p){var h,S,g=[];try{for(var m=D(p.actions),w=m.next();!w.done;w=m.next()){var O=w.value,L=y(p.type,O);L&&(g=g.concat(L))}}catch(j){h={error:j}}finally{try{w&&!w.done&&(S=m.return)&&S.call(m)}finally{if(h)throw h.error}}return v.forEach(function(j){i(j,u,n)}),v.length=0,g}var d=R(a.map(f));return[d,u]}const pr=Object.freeze(Object.defineProperty({__proto__:null,actionTypes:We,after:be,assign:Pe,cancel:xe,choose:hr,done:vt,doneInvoke:Te,error:je,escalate:dr,forwardTo:cr,getActionFunction:Yt,initEvent:Tt,isActionObject:lr,log:ur,pure:fr,raise:ge,resolveActions:Dt,resolveLog:we,resolveRaise:me,resolveSend:Se,resolveStop:Ae,respond:or,send:Z,sendParent:qt,sendTo:ir,sendUpdate:ar,start:Ee,stop:Oe,toActionObject:it,toActionObjects:B,toActivityDefinition:jt},Symbol.toStringTag,{value:"Module"}));var Nt=[],yr=function(e,t){Nt.push(e);var r=t(e);return Nt.pop(),r},gr=function(e){return e(Nt[Nt.length-1])};function De(e){var t;return t={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:e}}},t[ve]=function(){return this},t}function mr(e,t,r,n){var a,i=nr(e.src),o=(a=t==null?void 0:t.options.services)===null||a===void 0?void 0:a[i.type],s=e.data?fe(e.data,r,n):void 0,u=o?Ne(o,e.id,s):De(e.id);return u.meta=e,u}function Ne(e,t,r){var n=De(t);if(n.deferred=!0,Q(e)){var a=n.state=yr(void 0,function(){return(r?e.withContext(r):e).initialState});n.getSnapshot=function(){return a}}return n}var Rt=function(e){return e.type==="atomic"||e.type==="final"};function Re(e){return Object.keys(e.states).map(function(t){return e.states[t]})}function pt(e){return Re(e).filter(function(t){return t.type!=="history"})}function Ue(e){var t=[e];return Rt(e)?t:t.concat(R(pt(e).map(Ue)))}function yt(e,t){var r,n,a,i,o,s,u,l,v=new Set(e),y=Wt(v),f=new Set(t);try{for(var d=D(f),p=d.next();!p.done;p=d.next())for(var h=p.value,S=h.parent;S&&!f.has(S);)f.add(S),S=S.parent}catch(_){r={error:_}}finally{try{p&&!p.done&&(n=d.return)&&n.call(d)}finally{if(r)throw r.error}}var g=Wt(f);try{for(var m=D(f),w=m.next();!w.done;w=m.next()){var h=w.value;if(h.type==="compound"&&(!g.get(h)||!g.get(h).length))y.get(h)?y.get(h).forEach(function(F){return f.add(F)}):h.initialStateNodes.forEach(function(F){return f.add(F)});else if(h.type==="parallel")try{for(var O=(o=void 0,D(pt(h))),L=O.next();!L.done;L=O.next()){var j=L.value;f.has(j)||(f.add(j),y.get(j)?y.get(j).forEach(function(F){return f.add(F)}):j.initialStateNodes.forEach(function(F){return f.add(F)}))}}catch(F){o={error:F}}finally{try{L&&!L.done&&(s=O.return)&&s.call(O)}finally{if(o)throw o.error}}}}catch(_){a={error:_}}finally{try{w&&!w.done&&(i=m.return)&&i.call(m)}finally{if(a)throw a.error}}try{for(var $=D(f),I=$.next();!I.done;I=$.next())for(var h=I.value,S=h.parent;S&&!f.has(S);)f.add(S),S=S.parent}catch(_){u={error:_}}finally{try{I&&!I.done&&(l=$.return)&&l.call($)}finally{if(u)throw u.error}}return f}function Le(e,t){var r=t.get(e);if(!r)return{};if(e.type==="compound"){var n=r[0];if(n){if(Rt(n))return n.key}else return{}}var a={};return r.forEach(function(i){a[i.key]=Le(i,t)}),a}function Wt(e){var t,r,n=new Map;try{for(var a=D(e),i=a.next();!i.done;i=a.next()){var o=i.value;n.has(o)||n.set(o,[]),o.parent&&(n.has(o.parent)||n.set(o.parent,[]),n.get(o.parent).push(o))}}catch(s){t={error:s}}finally{try{i&&!i.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return n}function Sr(e,t){var r=yt([e],t);return Le(e,Wt(r))}function gt(e,t){return Array.isArray(e)?e.some(function(r){return r===t}):e instanceof Set?e.has(t):!1}function wr(e){return b([],A(new Set(R(b([],A(e.map(function(t){return t.ownEvents})),!1)))),!1)}function Ut(e,t){return t.type==="compound"?pt(t).some(function(r){return r.type==="final"&&gt(e,r)}):t.type==="parallel"?pt(t).every(function(r){return Ut(e,r)}):!1}function xr(e){return e===void 0&&(e=[]),e.reduce(function(t,r){return r.meta!==void 0&&(t[r.id]=r.meta),t},{})}function Ie(e){return new Set(R(e.map(function(t){return t.tags})))}function Fe(e,t){if(e===t)return!0;if(e===void 0||t===void 0)return!1;if(E(e)||E(t))return e===t;var r=Object.keys(e),n=Object.keys(t);return r.length===n.length&&r.every(function(a){return Fe(e[a],t[a])})}var V=function(){function e(t){var r=this,n;this.actions=[],this.activities=oe,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this._event=t._event,this._sessionid=t._sessionid,this.event=this._event.data,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||oe,this.meta=xr(t.configuration),this.events=t.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=t.configuration,this.transitions=t.transitions,this.children=t.children,this.done=!!t.done,this.tags=(n=Array.isArray(t.tags)?new Set(t.tags):t.tags)!==null&&n!==void 0?n:new Set,this.machine=t.machine,Object.defineProperty(this,"nextEvents",{get:function(){return wr(r.configuration)}})}return e.from=function(t,r){if(t instanceof e)return t.context!==r?new e({value:t.value,context:r,_event:t._event,_sessionid:null,historyValue:t.historyValue,history:t.history,actions:[],activities:t.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):t;var n=Tt;return new e({value:t,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},e.create=function(t){return new e(t)},e.inert=function(t,r){if(t instanceof e){if(!t.actions.length)return t;var n=Tt;return new e({value:t.value,context:r,_event:n,_sessionid:null,historyValue:t.historyValue,history:t.history,activities:t.activities,configuration:t.configuration,transitions:[],children:{}})}return e.from(t,r)},e.prototype.toStrings=function(t,r){var n=this;if(t===void 0&&(t=this.value),r===void 0&&(r="."),E(t))return[t];var a=Object.keys(t);return a.concat.apply(a,b([],A(a.map(function(i){return n.toStrings(t[i],r).map(function(o){return i+r+o})})),!1))},e.prototype.toJSON=function(){var t=this;t.configuration,t.transitions;var r=t.tags;t.machine;var n=Mt(t,["configuration","transitions","tags","machine"]);return c(c({},n),{tags:Array.from(r)})},e.prototype.matches=function(t){return Gt(t,this.value)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.can=function(t){var r;H&&q(!!this.machine,"state.can(...) used outside of a machine-created State object; this will always return false.");var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,t);return!!(n!=null&&n.transitions.length)&&n.transitions.some(function(a){return a.target!==void 0||a.actions.length})},e}(),Me={sync:!1,autoForward:!1},$e;(function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped"})($e||($e={}));var Er=function(e){return E(e)?c(c({},Me),{name:e}):c(c(c({},Me),{name:er()}),e)};function Or(e,t){var r=Er(t);return gr(function(n){if(!H){var a=Q(e)||T(e);q(!!n||a,'Attempted to spawn an Actor (ID: "'.concat(Q(e)?e.id:"undefined",'") outside of a service. This will have no effect.'))}return n?n.spawn(e,r.name,r):Ne(e,r.name)})}function Ar(e){if(typeof e=="string"){var t={type:e};return t.toString=function(){return e},t}return e}function Lt(e){return c(c({type:Et},e),{toJSON:function(){e.onDone,e.onError;var t=Mt(e,["onDone","onError"]);return c(c({},t),{type:Et,src:Ar(e.src)})}})}var at="",Xt="#",mt="*",ot={},st=function(e){return e[0]===Xt},Pr=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},br=function(e,t,r){var n=r.slice(0,-1).some(function(i){return!("cond"in i)&&!("in"in i)&&(E(i.target)||Q(i.target))}),a=t===at?"the transient event":"event '".concat(t,"'");q(!n,"One or more transitions for ".concat(a," on state '").concat(e.id,"' are unreachable. ")+"Make sure that the default transition is the last one defined.")},Tr=function(){function e(t,r,n,a){n===void 0&&(n="context"in t?t.context:void 0);var i=this,o;this.config=t,this._context=n,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(Pr(),r),this.parent=a==null?void 0:a.parent,this.key=this.config.key||(a==null?void 0:a.key)||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:ae),this.id=this.config.id||b([this.machine.key],A(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(o=this.config.schema)!==null&&o!==void 0?o:{},this.description=this.config.description,H||q(!("parallel"in this.config),'The "parallel" property is deprecated and will be removed in version 4.1. '.concat(this.config.parallel?"Replace with `type: 'parallel'`":"Use `type: '".concat(this.type,"'`")," in the config for state node '").concat(this.id,"' instead.")),this.initial=this.config.initial,this.states=this.config.states?ct(this.config.states,function(l,v){var y,f=new e(l,{},void 0,{parent:i,key:v});return Object.assign(i.idMap,c((y={},y[f.id]=f,y),f.idMap)),f}):ot;var s=0;function u(l){var v,y;l.order=s++;try{for(var f=D(Re(l)),d=f.next();!d.done;d=f.next()){var p=d.value;u(p)}}catch(h){v={error:h}}finally{try{d&&!d.done&&(y=f.return)&&y.call(f)}finally{if(v)throw v.error}}}u(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(l){var v=l.event;return v===at}):at in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=G(this.config.entry||this.config.onEntry).map(function(l){return it(l)}),this.onExit=G(this.config.exit||this.config.onExit).map(function(l){return it(l)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=G(this.config.invoke).map(function(l,v){var y,f;if(Q(l)){var d=bt(i.id,v);return i.machine.options.services=c((y={},y[d]=l,y),i.machine.options.services),Lt({src:d,id:d})}else if(E(l.src)){var d=l.id||bt(i.id,v);return Lt(c(c({},l),{id:d,src:l.src}))}else if(Q(l.src)||T(l.src)){var d=l.id||bt(i.id,v);return i.machine.options.services=c((f={},f[d]=l.src,f),i.machine.options.services),Lt(c(c({id:d},l),{src:d}))}else{var p=l.src;return Lt(c(c({id:bt(i.id,v)},l),{src:p}))}}),this.activities=G(this.config.activities).concat(this.invoke).map(function(l){return jt(l)}),this.transition=this.transition.bind(this),this.tags=G(this.config.tags)}return e.prototype._init=function(){this.__cache.transitions||Ue(this).forEach(function(t){return t.on})},e.prototype.withConfig=function(t,r){var n=this.options,a=n.actions,i=n.activities,o=n.guards,s=n.services,u=n.delays;return new e(this.config,{actions:c(c({},a),t.actions),activities:c(c({},i),t.activities),guards:c(c({},o),t.guards),services:c(c({},s),t.services),delays:c(c({},u),t.delays)},r!=null?r:this.context)},e.prototype.withContext=function(t){return new e(this.config,this.options,t)},Object.defineProperty(e.prototype,"context",{get:function(){return T(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:ct(this.states,function(t){return t.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return this.definition},Object.defineProperty(e.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var t=this.transitions;return this.__cache.on=t.reduce(function(r,n){return r[n.eventType]=r[n.eventType]||[],r[n.eventType].push(n),r},{})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),e.prototype.getCandidates=function(t){if(this.__cache.candidates[t])return this.__cache.candidates[t];var r=t===at,n=this.transitions.filter(function(a){var i=a.eventType===t;return r?i:i||a.eventType===mt});return this.__cache.candidates[t]=n,n},e.prototype.getDelayedTransitions=function(){var t=this,r=this.config.after;if(!r)return[];var n=function(i,o){var s=T(i)?"".concat(t.id,":delay[").concat(o,"]"):i,u=be(s,t.id);return t.onEntry.push(Z(u,{delay:i})),t.onExit.push(xe(u)),u},a=dt(r)?r.map(function(i,o){var s=n(i.delay,o);return c(c({},i),{event:s})}):R(Object.keys(r).map(function(i,o){var s=r[i],u=E(s)?{target:s}:s,l=isNaN(+i)?i:+i,v=n(l,o);return G(u).map(function(y){return c(c({},y),{event:v,delay:l})})}));return a.map(function(i){var o=i.delay;return c(c({},t.formatTransition(i)),{delay:o})})},e.prototype.getStateNodes=function(t){var r,n=this;if(!t)return[];var a=t instanceof V?t.value:ft(t,this.delimiter);if(E(a)){var i=this.getStateNode(a).initial;return i!==void 0?this.getStateNodes((r={},r[a]=i,r)):[this,this.states[a]]}var o=Object.keys(a),s=[this];return s.push.apply(s,b([],A(R(o.map(function(u){return n.getStateNode(u).getStateNodes(a[u])}))),!1)),s},e.prototype.handles=function(t){var r=se(t);return this.events.includes(r)},e.prototype.resolveState=function(t){var r=t instanceof V?t:V.create(t),n=Array.from(yt([],this.getStateNodes(r.value)));return new V(c(c({},r),{value:this.resolve(r.value),configuration:n,done:Ut(n,this),tags:Ie(n),machine:this.machine}))},e.prototype.transitionLeafNode=function(t,r,n){var a=this.getStateNode(t),i=a.next(r,n);return!i||!i.transitions.length?this.next(r,n):i},e.prototype.transitionCompoundNode=function(t,r,n){var a=Object.keys(t),i=this.getStateNode(a[0]),o=i._transition(t[a[0]],r,n);return!o||!o.transitions.length?this.next(r,n):o},e.prototype.transitionParallelNode=function(t,r,n){var a,i,o={};try{for(var s=D(Object.keys(t)),u=s.next();!u.done;u=s.next()){var l=u.value,v=t[l];if(v){var y=this.getStateNode(l),f=y._transition(v,r,n);f&&(o[l]=f)}}}catch(g){a={error:g}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(a)throw a.error}}var d=Object.keys(o).map(function(g){return o[g]}),p=R(d.map(function(g){return g.transitions})),h=d.some(function(g){return g.transitions.length>0});if(!h)return this.next(r,n);var S=R(Object.keys(o).map(function(g){return o[g].configuration}));return{transitions:p,exitSet:R(d.map(function(g){return g.exitSet})),configuration:S,source:r,actions:R(Object.keys(o).map(function(g){return o[g].actions}))}},e.prototype._transition=function(t,r,n){return E(t)?this.transitionLeafNode(t,r,n):Object.keys(t).length===1?this.transitionCompoundNode(t,r,n):this.transitionParallelNode(t,r,n)},e.prototype.getTransitionData=function(t,r){return this._transition(t.value,t,ht(r))},e.prototype.next=function(t,r){var n,a,i=this,o=r.name,s=[],u=[],l;try{for(var v=D(this.getCandidates(o)),y=v.next();!y.done;y=v.next()){var f=y.value,d=f.cond,p=f.in,h=t.context,S=p?E(p)&&st(p)?t.matches(ft(this.getStateNodeById(p).path,this.delimiter)):Gt(ft(p,this.delimiter),Ve(this.path.slice(0,-2))(t.value)):!0,g=!1;try{g=!d||pe(this.machine,d,h,r,t)}catch(O){throw new Error("Unable to evaluate guard '".concat(d.name||d.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(O.message))}if(g&&S){f.target!==void 0&&(u=f.target),s.push.apply(s,b([],A(f.actions),!1)),l=f;break}}}catch(O){n={error:O}}finally{try{y&&!y.done&&(a=v.return)&&a.call(v)}finally{if(n)throw n.error}}if(l){if(!u.length)return{transitions:[l],exitSet:[],configuration:t.value?[this]:[],source:t,actions:s};var m=R(u.map(function(O){return i.getRelativeStateNodes(O,t.historyValue)})),w=!!l.internal;return{transitions:[l],exitSet:w?[]:R(u.map(function(O){return i.getPotentiallyReenteringNodes(O)})),configuration:m,source:t,actions:s}}},e.prototype.getPotentiallyReenteringNodes=function(t){if(this.order<t.order)return[this];for(var r=[],n=this,a=t;n&&n!==a;)r.push(n),n=n.parent;return n!==a?[]:(r.push(a),r)},e.prototype.getActions=function(t,r,n,a,i,o,s){var u,l,v,y,f=this,d=o?yt([],this.getStateNodes(o.value)):[],p=new Set;try{for(var h=D(Array.from(t).sort(function(x,N){return x.order-N.order})),S=h.next();!S.done;S=h.next()){var g=S.value;(!gt(d,g)||gt(n.exitSet,g)||g.parent&&p.has(g.parent))&&p.add(g)}}catch(x){u={error:x}}finally{try{S&&!S.done&&(l=h.return)&&l.call(h)}finally{if(u)throw u.error}}try{for(var m=D(d),w=m.next();!w.done;w=m.next()){var g=w.value;(!gt(t,g)||gt(n.exitSet,g.parent))&&n.exitSet.push(g)}}catch(x){v={error:x}}finally{try{w&&!w.done&&(y=m.return)&&y.call(m)}finally{if(v)throw v.error}}n.exitSet.sort(function(x,N){return N.order-x.order});var O=Array.from(p).sort(function(x,N){return x.order-N.order}),L=new Set(n.exitSet),j=R(O.map(function(x){var N=[];if(x.type!=="final")return N;var k=x.parent;if(!k.parent)return N;N.push(vt(x.id,x.doneData),vt(k.id,x.doneData?fe(x.doneData,a,i):void 0));var W=k.parent;return W.type==="parallel"&&pt(W).every(function(St){return Ut(n.configuration,St)})&&N.push(vt(W.id)),N})),$=O.map(function(x){var N=x.onEntry,k=x.activities.map(function(W){return Ee(W)});return{type:"entry",actions:B(s?b(b([],A(N),!1),A(k),!1):b(b([],A(k),!1),A(N),!1),f.machine.options.actions)}}).concat({type:"state_done",actions:j.map(function(x){return ge(x)})}),I=Array.from(L).map(function(x){return{type:"exit",actions:B(b(b([],A(x.onExit),!1),A(x.activities.map(function(N){return Oe(N)})),!1),f.machine.options.actions)}}),_=I.concat({type:"transition",actions:B(n.actions,this.machine.options.actions)}).concat($);if(r){var F=B(R(b([],A(t),!1).sort(function(x,N){return N.order-x.order}).map(function(x){return x.onExit})),this.machine.options.actions).filter(function(x){return!ye(x)});return _.concat({type:"stop",actions:F})}return _},e.prototype.transition=function(t,r,n,a){t===void 0&&(t=this.initialState);var i=ht(r),o;if(t instanceof V)o=n===void 0?t:this.resolveState(V.from(t,n));else{var s=E(t)?this.resolve(At(this.getResolvedPath(t))):this.resolve(t),u=n!=null?n:this.machine.context;o=this.resolveState(V.from(s,u))}if(!H&&i.name===mt)throw new Error("An event cannot have the wildcard type ('".concat(mt,"')"));if(this.strict&&!this.events.includes(i.name)&&!Qe(i.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(i.name,"'"));var l=this._transition(o.value,o,i)||{transitions:[],configuration:[],exitSet:[],source:o,actions:[]},v=yt([],this.getStateNodes(o.value)),y=l.configuration.length?yt(v,l.configuration):v;return l.configuration=b([],A(y),!1),this.resolveTransition(l,o,o.context,a,i)},e.prototype.resolveRaisedTransition=function(t,r,n,a){var i,o=t.actions;return t=this.transition(t,r,void 0,a),t._event=n,t.event=n.data,(i=t.actions).unshift.apply(i,b([],A(o),!1)),t},e.prototype.resolveTransition=function(t,r,n,a,i){var o,s,u,l,v=this;i===void 0&&(i=Tt);var y=t.configuration,f=!r||t.transitions.length>0,d=f?t.configuration:r?r.configuration:[],p=Ut(d,this),h=f?Sr(this.machine,y):void 0,S=r?r.historyValue?r.historyValue:t.source?this.machine.historyValue(r.value):void 0:void 0,g=this.getActions(new Set(d),p,t,n,i,r,a),m=r?c({},r.activities):{};try{for(var w=D(g),O=w.next();!O.done;O=w.next()){var L=O.value;try{for(var j=(u=void 0,D(L.actions)),$=j.next();!$.done;$=j.next()){var I=$.value;I.type===$t?m[I.activity.id||I.activity.type]=I:I.type===kt&&(m[I.activity.id||I.activity.type]=!1)}}catch(Y){u={error:Y}}finally{try{$&&!$.done&&(l=j.return)&&l.call(j)}finally{if(u)throw u.error}}}}catch(Y){o={error:Y}}finally{try{O&&!O.done&&(s=w.return)&&s.call(w)}finally{if(o)throw o.error}}var _=A(Dt(this,r,n,i,g,a,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),F=_[0],x=_[1],N=A(Ze(F,ye),2),k=N[0],W=N[1],St=F.filter(function(Y){var ut;return Y.type===$t&&((ut=Y.activity)===null||ut===void 0?void 0:ut.type)===Et}),Kt=St.reduce(function(Y,ut){return Y[ut.activity.id]=mr(ut.activity,v.machine,x,i),Y},r?c({},r.children):{}),tt=new V({value:h||r.value,context:x,_event:i,_sessionid:r?r._sessionid:null,historyValue:h?S?tr(S,h):void 0:r?r.historyValue:void 0,history:!h||t.source?r:void 0,actions:h?W:[],activities:h?m:r?r.activities:{},events:[],configuration:d,transitions:t.transitions,children:Kt,done:p,tags:Ie(d),machine:this}),K=n!==x;tt.changed=i.name===Ht||K;var z=tt.history;z&&delete z.history;var _e=!p&&(this._transient||y.some(function(Y){return Y._transient}));if(!f&&(!_e||i.name===at))return tt;var J=tt;if(!p)for(_e&&(J=this.resolveRaisedTransition(J,{type:te},i,a));k.length;){var Rr=k.shift();J=this.resolveRaisedTransition(J,Rr._event,i,a)}var Ur=J.changed||(z?!!J.actions.length||K||typeof z.value!=typeof J.value||!Fe(J.value,z.value):void 0);return J.changed=Ur,J.history=z,J},e.prototype.getStateNode=function(t){if(st(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '".concat(t,"' from '").concat(this.id,"'; no child states exist."));var r=this.states[t];if(!r)throw new Error("Child state '".concat(t,"' does not exist on '").concat(this.id,"'"));return r},e.prototype.getStateNodeById=function(t){var r=st(t)?t.slice(Xt.length):t;if(r===this.id)return this;var n=this.machine.idMap[r];if(!n)throw new Error("Child state node '#".concat(r,"' does not exist on machine '").concat(this.id,"'"));return n},e.prototype.getStateNodeByPath=function(t){if(typeof t=="string"&&st(t))try{return this.getStateNodeById(t.slice(1))}catch{}for(var r=zt(t,this.delimiter).slice(),n=this;r.length;){var a=r.shift();if(!a.length)break;n=n.getStateNode(a)}return n},e.prototype.resolve=function(t){var r,n=this;if(!t)return this.initialStateValue||ot;switch(this.type){case"parallel":return ct(this.initialStateValue,function(i,o){return i?n.getStateNode(o).resolve(t[o]||i):ot});case"compound":if(E(t)){var a=this.getStateNode(t);return a.type==="parallel"||a.type==="compound"?(r={},r[t]=a.initialStateValue,r):t}return Object.keys(t).length?ct(t,function(i,o){return i?n.getStateNode(o).resolve(i):ot}):this.initialStateValue||{};default:return t||ot}},e.prototype.getResolvedPath=function(t){if(st(t)){var r=this.machine.idMap[t.slice(Xt.length)];if(!r)throw new Error("Unable to find state node '".concat(t,"'"));return r.path}return zt(t,this.delimiter)},Object.defineProperty(e.prototype,"initialStateValue",{get:function(){var t;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var r;if(this.type==="parallel")r=ue(this.states,function(n){return n.initialStateValue||ot},function(n){return n.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));r=Rt(this.states[this.initial])?this.initial:(t={},t[this.initial]=this.states[this.initial].initialStateValue,t)}else r={};return this.__cache.initialStateValue=r,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),e.prototype.getInitialState=function(t,r){this._init();var n=this.getStateNodes(t);return this.resolveTransition({configuration:n,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,r!=null?r:this.machine.context,void 0)},Object.defineProperty(e.prototype,"initialState",{get:function(){var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"target",{get:function(){var t;if(this.type==="history"){var r=this.config;E(r.target)?t=st(r.target)?At(this.machine.getStateNodeById(r.target).path.slice(this.path.length-1)):r.target:t=r.target}return t},enumerable:!1,configurable:!0}),e.prototype.getRelativeStateNodes=function(t,r,n){return n===void 0&&(n=!0),n?t.type==="history"?t.resolveHistory(r):t.initialStateNodes:[t]},Object.defineProperty(e.prototype,"initialStateNodes",{get:function(){var t=this;if(Rt(this))return[this];if(this.type==="compound"&&!this.initial)return H||q(!1,"Compound state node '".concat(this.id,"' has no initial state.")),[this];var r=Pt(this.initialStateValue);return R(r.map(function(n){return t.getFromRelativePath(n)}))},enumerable:!1,configurable:!0}),e.prototype.getFromRelativePath=function(t){if(!t.length)return[this];var r=A(t),n=r[0],a=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(n,"' from node with no states"));var i=this.getStateNode(n);if(i.type==="history")return i.resolveHistory();if(!this.states[n])throw new Error("Child state '".concat(n,"' does not exist on '").concat(this.id,"'"));return this.states[n].getFromRelativePath(a)},e.prototype.historyValue=function(t){if(Object.keys(this.states).length)return{current:t||this.initialStateValue,states:ue(this.states,function(r,n){if(!t)return r.historyValue();var a=E(t)?void 0:t[n];return r.historyValue(a||r.initialStateValue)},function(r){return!r.history})}},e.prototype.resolveHistory=function(t){var r=this;if(this.type!=="history")return[this];var n=this.parent;if(!t){var a=this.target;return a?R(Pt(a).map(function(o){return n.getFromRelativePath(o)})):n.initialStateNodes}var i=Ke(n.path,"states")(t).current;return E(i)?[n.getStateNode(i)]:R(Pt(i).map(function(o){return r.history==="deep"?n.getFromRelativePath(o):[n.states[o[0]]]}))},Object.defineProperty(e.prototype,"stateIds",{get:function(){var t=this,r=R(Object.keys(this.states).map(function(n){return t.states[n].stateIds}));return[this.id].concat(r)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"events",{get:function(){var t,r,n,a;if(this.__cache.events)return this.__cache.events;var i=this.states,o=new Set(this.ownEvents);if(i)try{for(var s=D(Object.keys(i)),u=s.next();!u.done;u=s.next()){var l=u.value,v=i[l];if(v.states)try{for(var y=(n=void 0,D(v.events)),f=y.next();!f.done;f=y.next()){var d=f.value;o.add("".concat(d))}}catch(p){n={error:p}}finally{try{f&&!f.done&&(a=y.return)&&a.call(y)}finally{if(n)throw n.error}}}}catch(p){t={error:p}}finally{try{u&&!u.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ownEvents",{get:function(){var t=new Set(this.transitions.filter(function(r){return!(!r.target&&!r.actions.length&&r.internal)}).map(function(r){return r.eventType}));return Array.from(t)},enumerable:!1,configurable:!0}),e.prototype.resolveTarget=function(t){var r=this;if(t!==void 0)return t.map(function(n){if(!E(n))return n;var a=n[0]===r.delimiter;if(a&&!r.parent)return r.getStateNodeByPath(n.slice(1));var i=a?r.key+n:n;if(r.parent)try{var o=r.parent.getStateNodeByPath(i);return o}catch(s){throw new Error("Invalid transition definition for state node '".concat(r.id,`':
`).concat(s.message))}else return r.getStateNodeByPath(i)})},e.prototype.formatTransition=function(t){var r=this,n=rr(t.target),a="internal"in t?t.internal:n?n.some(function(u){return E(u)&&u[0]===r.delimiter}):!0,i=this.machine.options.guards,o=this.resolveTarget(n),s=c(c({},t),{actions:B(G(t.actions)),cond:he(t.cond,i),target:o,source:this,internal:a,eventType:t.event,toJSON:function(){return c(c({},s),{target:s.target?s.target.map(function(u){return"#".concat(u.id)}):void 0,source:"#".concat(r.id)})}});return s},e.prototype.formatTransitions=function(){var t,r,n=this,a;if(!this.config.on)a=[];else if(Array.isArray(this.config.on))a=this.config.on;else{var i=this.config.on,o=mt,s=i[o],u=s===void 0?[]:s,l=Mt(i,[typeof o=="symbol"?o:o+""]);a=R(Object.keys(l).map(function(m){!H&&m===at&&q(!1,"Empty string transition configs (e.g., `{ on: { '': ... }}`) for transient transitions are deprecated. Specify the transition in the `{ always: ... }` property instead. "+'Please check the `on` configuration for "#'.concat(n.id,'".'));var w=nt(m,l[m]);return H||br(n,m,w),w}).concat(nt(mt,u)))}var v=this.config.always?nt("",this.config.always):[],y=this.config.onDone?nt(String(vt(this.id)),this.config.onDone):[];H||q(!(this.config.onDone&&!this.parent),'Root nodes cannot have an ".onDone" transition. Please check the config of "'.concat(this.id,'".'));var f=R(this.invoke.map(function(m){var w=[];return m.onDone&&w.push.apply(w,b([],A(nt(String(Te(m.id)),m.onDone)),!1)),m.onError&&w.push.apply(w,b([],A(nt(String(je(m.id)),m.onError)),!1)),w})),d=this.after,p=R(b(b(b(b([],A(y),!1),A(f),!1),A(a),!1),A(v),!1).map(function(m){return G(m).map(function(w){return n.formatTransition(w)})}));try{for(var h=D(d),S=h.next();!S.done;S=h.next()){var g=S.value;p.push(g)}}catch(m){t={error:m}}finally{try{S&&!S.done&&(r=h.return)&&r.call(h)}finally{if(t)throw t.error}}return p},e}(),ke=!1;function Ce(e,t){return!H&&!("predictableActionArguments"in e)&&!ke&&(ke=!0,console.warn("It is highly recommended to set `predictableActionArguments` to `true` when using `createMachine`. https://xstate.js.org/docs/guides/actions.html")),new Tr(e,t)}var C=Pe,Bt=Z;const It={progress:null,loaded:0,error:null,bucketId:void 0,file:void 0,id:void 0},He=()=>Ce({predictableActionArguments:!0,schema:{context:{},events:{}},tsTypes:{},context:{...It},initial:"idle",on:{DESTROY:{actions:"sendDestroy",target:"stopped"}},states:{idle:{on:{ADD:{actions:"addFile"},UPLOAD:{cond:"hasFile",target:"uploading"}}},uploading:{entry:"resetProgress",on:{UPLOAD_PROGRESS:{actions:["incrementProgress","sendProgress"]},UPLOAD_DONE:"uploaded",UPLOAD_ERROR:"error",CANCEL:"idle"},invoke:{src:"uploadFile"}},uploaded:{entry:["setFileMetadata","sendDone"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},error:{entry:["setError","sendError"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},stopped:{type:"final"}}},{guards:{hasFile:(e,t)=>!!e.file||!!t.file},actions:{incrementProgress:C({loaded:(e,{loaded:t})=>t,progress:(e,{progress:t})=>t}),setFileMetadata:C({id:(e,{id:t})=>t,bucketId:(e,{bucketId:t})=>t,progress:e=>100}),setError:C({error:(e,{error:t})=>t}),sendProgress:()=>{},sendError:()=>{},sendDestroy:()=>{},sendDone:()=>{},resetProgress:C({progress:e=>null,loaded:e=>0}),resetContext:C(e=>It),addFile:C({file:(e,{file:t})=>t,bucketId:(e,{bucketId:t})=>t,id:(e,{id:t})=>t})},services:{uploadFile:(e,t)=>r=>{const n=t.file||e.file,a=new FormData;a.append("file[]",n);let i=0;return M(t.url,a,{fileId:t.id||e.id,bucketId:t.bucketId||e.bucketId,accessToken:t.accessToken,adminSecret:t.adminSecret,name:t.name||n.name,onUploadProgress:o=>{const s=o.total?Math.round(o.loaded*n.size/o.total):0,u=s-i;i=s,r({type:"UPLOAD_PROGRESS",progress:o.total?Math.round(s*100/o.total):0,loaded:s,additions:u})}}).then(({fileMetadata:o,error:s})=>{if(s&&r({type:"UPLOAD_ERROR",error:s}),o&&!("processedFiles"in o)){const{id:u,bucketId:l}=o;r({type:"UPLOAD_DONE",id:u,bucketId:l})}if(o&&"processedFiles"in o){const{id:u,bucketId:l}=o.processedFiles[0];r({type:"UPLOAD_DONE",id:u,bucketId:l})}}),()=>{}}}}),{pure:Vt,sendParent:Ft}=pr,jr=()=>Ce({id:"files-list",schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,context:{progress:null,files:[],loaded:0,total:0},initial:"idle",on:{UPLOAD:{cond:"hasFileToDownload",actions:"addItem",target:"uploading"},ADD:{actions:"addItem"},REMOVE:{actions:"removeItem"}},states:{idle:{entry:["resetProgress","resetLoaded","resetTotal"],on:{CLEAR:{actions:"clearList",target:"idle"}}},uploading:{entry:["upload","startProgress","resetLoaded","resetTotal"],on:{UPLOAD_PROGRESS:{actions:["incrementProgress"]},UPLOAD_DONE:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],UPLOAD_ERROR:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],CANCEL:{actions:"cancel",target:"idle"}}},uploaded:{entry:"setUploaded",on:{CLEAR:{actions:"clearList",target:"idle"}}},error:{on:{CLEAR:{actions:"clearList",target:"idle"}}}}},{guards:{hasFileToDownload:(e,t)=>e.files.some(r=>r.getSnapshot().matches("idle"))||!!t.files,isAllUploaded:e=>e.files.every(t=>{var r;return(r=t.getSnapshot())==null?void 0:r.matches("uploaded")}),isAllUploadedOrError:e=>e.files.every(t=>{const r=t.getSnapshot();return(r==null?void 0:r.matches("error"))||(r==null?void 0:r.matches("uploaded"))})},actions:{incrementProgress:C((e,t)=>{const r=e.loaded+t.additions,n=Math.round(r*100/e.total);return{...e,loaded:r,progress:n}}),setUploaded:C({progress:e=>100,loaded:({files:e})=>e.map(t=>t.getSnapshot()).filter(t=>t.matches("uploaded")).reduce((t,r)=>{var n;return t+((n=r.context.file)==null?void 0:n.size)},0)}),resetTotal:C({total:({files:e})=>e.map(t=>t.getSnapshot()).filter(t=>!t.matches("uploaded")).reduce((t,r)=>{var n;return t+((n=r.context.file)==null?void 0:n.size)},0)}),resetLoaded:C({loaded:e=>0}),startProgress:C({progress:e=>0}),resetProgress:C({progress:e=>null}),addItem:C((e,{files:t,bucketId:r})=>{const n=t?Array.isArray(t)?t:"item"in t?Array.from(t):[t]:[],a=e.total+n.reduce((o,s)=>o+s.size,0),i=Math.round(e.loaded*100/a);return{files:[...e.files,...n.map(o=>Or(He().withConfig({actions:{sendProgress:Ft((s,{additions:u})=>({type:"UPLOAD_PROGRESS",additions:u})),sendDone:Ft("UPLOAD_DONE"),sendError:Ft("UPLOAD_ERROR"),sendDestroy:Ft("REMOVE")}}).withContext({...It,file:o,bucketId:r}),{sync:!0}))],total:a,loaded:e.loaded,progress:i}}),removeItem:C({files:e=>e.files.filter(t=>{var n,a;const r=(n=t.getSnapshot())==null?void 0:n.matches("stopped");return r&&((a=t.stop)==null||a.call(t)),!r})}),clearList:Vt(e=>e.files.map(t=>Bt({type:"DESTROY"},{to:t.id}))),upload:Vt((e,t)=>e.files.map(r=>Bt(t,{to:r.id}))),cancel:Vt(e=>e.files.map(t=>Bt({type:"CANCEL"},{to:t.id})))}}),Dr=async(e,t)=>new Promise(r=>{t.send({type:"UPLOAD",...e}),t.subscribe(n=>{var a;n.matches("error")?r({error:n.context.error,isError:!0,isUploaded:!1}):n.matches("uploaded")&&r({error:null,isError:!1,isUploaded:!0,id:n.context.id,bucketId:n.context.id,name:(a=n.context.file)==null?void 0:a.name})})}),Nr=async(e,t)=>new Promise(r=>{t.send({type:"UPLOAD",...e,files:e.files}),t.onTransition(n=>{n.matches("error")?r({errors:n.context.files.filter(a=>{var i;return(i=a.getSnapshot())==null?void 0:i.context.error}),isError:!0,files:[]}):n.matches("uploaded")&&r({errors:[],isError:!1,files:n.context.files})})});U.HasuraStorageApi=Qt,U.HasuraStorageClient=Ge,U.INITIAL_FILE_CONTEXT=It,U.appendImageTransformationParameters=X,U.createFileUploadMachine=He,U.createMultipleFilesUploadMachine=jr,U.uploadFilePromise=Dr,U.uploadMultipleFilesPromise=Nr,Object.defineProperty(U,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=hasura-storage-js.umd.js.map
